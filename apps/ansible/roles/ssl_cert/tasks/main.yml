---
- name: Check if SSL is enabled for this app
  debug:
    msg: "SSL certificate setup {{ 'enabled' if (app.ssl_enabled | default(ssl_default_enabled)) else 'disabled' }} for {{ app.domain_name }}"

- name: Check if certificate already exists
  stat:
    path: "/etc/letsencrypt/live/{{ app.domain_name }}/fullchain.pem"
  register: cert_exists

- name: Setup SSL certificate with certbot
  command: >
    certbot --nginx -d {{ app.domain_name }} 
    --non-interactive --agree-tos -m {{ app.user_email | default(default_user_email) }} --redirect
  when: 
    - ssl_enabled | default(ssl_default_enabled)
  register: certbot_result

- name: Display certbot result
  debug:
    var: certbot_result.stdout_lines
  when: certbot_result is defined and certbot_result.stdout_lines is defined

- name: Renew existing certificate if needed
  command: certbot renew --nginx --cert-name {{ app.domain_name }}
  when: 
    - ssl_enabled | default(ssl_default_enabled)
    - cert_exists.stat.exists
  register: cert_renewal
  failed_when: cert_renewal.rc != 0 and "not yet due for renewal" not in cert_renewal.stdout
